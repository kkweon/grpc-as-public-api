apiVersion: apps/v1
kind: Deployment
metadata:
  labels:
    app: hello-server
  annotations:
    sidecar.istio.io/inject: "false"
  name: hello-server
spec:
  replicas: 1
  selector:
    matchLabels:
      app: hello-server
  template:
    metadata:
      labels:
        app: hello-server
      annotations:
        sidecar.istio.io/inject: "false"
    spec:
      containers:
        - image: kkweon/hello-server
          name: hello-server
          ports:
            - name: https
              containerPort: 7900
          command:
            - "/app/server"

          args:
            - "-listen-addr=0.0.0.0:7900"
            - "-tls-cert=/etc/server/tls.crt"
            - "-tls-key=/etc/server/tls.key"

          readinessProbe:
            initialDelaySeconds: 5
            exec:
              command:
                - "/bin/grpc_health_probe"
                - "-addr=0.0.0.0:7900"
                - "-tls"
                - "-tls-server-name=k8s.kkweon.dev"
                #- "-tls-client-cert=/etc/server/tls.crt"
                #- "-tls-client-key=/etc/server/tls.key"

          livenessProbe:
            initialDelaySeconds: 10
            exec:
              command:
                - "/bin/grpc_health_probe"
                - "-addr=0.0.0.0:7900"
                - "-tls"
                - "-tls-server-name=k8s.kkweon.dev"
                #- "-tls-client-cert=/etc/server/tls.crt"
                #- "-tls-client-key=/etc/server/tls.key"

          volumeMounts:
            - name: hello-tls
              readOnly: true
              mountPath: /etc/server

      volumes:
        - name: "hello-tls"
          secret:
            secretName: "kkweon-tls"
